<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container mt-5">
        <h2 class="mb-4">–†–µ–¥–∞–∫—Ç–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤</h2>

        <div class="mb-3">
            <label for="question" class="form-label">–í–æ–ø—Ä–æ—Å:</label>
            <textarea id="question" class="form-control" rows="3"></textarea>
        </div>

        <div class="mb-3">
            <label for="answer" class="form-label">–û—Ç–≤–µ—Ç:</label>
            <textarea id="answer" class="form-control" rows="20"></textarea>
        </div>

        <!-- –ì—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∏ —Å–ª–µ–¥—É—é—â–∏–º -->
        <div class="mb-3">
            <div class="btn-group" role="group" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤">
                <button class="btn btn-secondary" onclick="prev()">‚¨Ö –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
                <button class="btn btn-primary" onclick="save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-danger" onclick="del()">üóë –£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="next()">‚û° –°–ª–µ–¥—É—é—â–∏–π</button>
            </div>
        </div>

        <p id="status" class="text-success"></p>
    </div>

<script>
    let questions = [];
    let index = 0;
    let isDirty = false;

    const questionEl = document.getElementById("question");
    const answerEl = document.getElementById("answer");
    const statusEl = document.getElementById("status");

    questionEl.addEventListener("input", markChanged);
    answerEl.addEventListener("input", markChanged);

    function getIdFromURL() {
        // –ø–æ–¥–¥–µ—Ä–∂–∏–º –∏ /q/123, –∏ ?id=123
        const m = window.location.pathname.match(/^\/q\/(\d+)/);
        if (m) return parseInt(m[1], 10);
        const p = new URLSearchParams(window.location.search).get("id");
        return p ? parseInt(p, 10) : null;
    }

    async function load() {
        const res = await fetch("/api/questions");
        questions = await res.json();

        // –≤—ã–±—Ä–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–æ id –∏–∑ URL (–µ—Å–ª–∏ –µ—Å—Ç—å)
        const idFromURL = getIdFromURL();
        if (idFromURL) {
            const i = questions.findIndex(q => q.id === idFromURL);
            if (i !== -1) index = i;
        }

        show();
    }

    function markChanged() {
        if (!isDirty) {
            isDirty = true;
            statusEl.textContent = "‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ";
        }
    }

    function show() {
        if (questions.length === 0) {
            questionEl.value = "–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤";
            answerEl.value = "";
            statusEl.textContent = "";
            // –ü–æ—á–∏—Å—Ç–∏–º URL, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ /q/...
            if (window.location.pathname.startsWith("/q/")) {
                history.replaceState(null, "", "/");
            }
            return;
        }

        index = Math.max(0, Math.min(index, questions.length - 1));
        const q = questions[index];

        questionEl.value = q.question || "";
        answerEl.value = q.answer || "";

        // –û–±–Ω–æ–≤–ª—è–µ–º URL –Ω–∞ ¬´–∫—Ä–∞—Å–∏–≤—ã–π¬ª
        const newPath = `/q/${q.id}`;
        if (window.location.pathname !== newPath) {
            history.replaceState(null, "", newPath);
        }

        isDirty = false;
        statusEl.textContent = "";
    }

    async function save() {
        const q = questions[index];
        const form = new FormData();
        form.append("id", q.id);
        form.append("question", questionEl.value);
        form.append("answer", answerEl.value);

        await fetch("/api/update", { method: "POST", body: form });

        // –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
        q.question = questionEl.value;
        q.answer = answerEl.value;

        isDirty = false;
        statusEl.textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
    }

    async function del() {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?")) return;

        const q = questions[index];
        const form = new FormData();
        form.append("id", q.id);

        await fetch("/api/delete", { method: "POST", body: form });

        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å–µ–¥–Ω–∏–π
        questions.splice(index, 1);
        if (index >= questions.length) index = Math.max(0, questions.length - 1);
        show();
    }

    function next() {
        if (index + 1 < questions.length) {
            index++;
            show();
        }
    }

    function prev() {
        if (index > 0) {
            index--;
            show();
        }
    }

    load();
</script>


</body>

</html>
